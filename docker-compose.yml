version: '3.8'

services:
  # IBM MQ Server
  ibm-mq:
    image: icr.io/ibm-messaging/mq:9.4.0.0-r1
    container_name: ibm-mq
    hostname: ibm-mq
    ports:
      - "1414:1414"
      - "9443:9443"
    environment:
      LICENSE: accept
      MQ_QMGR_NAME: QM1
      MQ_APP_PASSWORD: passw0rd
    volumes:
      - ibm_mq_data:/mnt/mqm
    healthcheck:
      test: ["CMD", "/opt/mqm/bin/dspmq"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Payara Server
  payara:
    image: payara/server-full:6.2024.10-jdk21
    container_name: payara
    hostname: payara
    ports:
      - "8080:8080"
      - "4848:4848"
    environment:
      # IBM MQ Connection
      MQ_HOST: ibm-mq
      MQ_PORT: 1414
      MQ_QMGR: QM1
      MQ_CHANNEL: DEV.APP.SVRCONN
    volumes:
      - ./build/libs/test-mdb.war:/tmp/test-mdb.war:ro
      - ./docker/payara/wmq.jakarta.jmsra.rar:/tmp/wmq.jakarta.jmsra.rar:ro
      - ./docker/payara/post-boot-commands.asadmin:/opt/payara/config/post-boot-commands.asadmin:ro
    depends_on:
      ibm-mq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4848"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ibm_mq_data:
