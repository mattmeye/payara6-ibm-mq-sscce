services:
  # IBM MQ Server
  ibm-mq:
    build:
      context: ./docker/ibm-mq
      dockerfile: Dockerfile
    container_name: ibm-mq
    hostname: ibm-mq
    ports:
      - "1415:1414"
      - "9444:9443"
    volumes:
      - ibm_mq_data:/mnt/mqm
    healthcheck:
      test: ["CMD", "/opt/mqm/bin/dspmq"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Payara Server
  payara:
    image: payara/server-full:6.2024.10-jdk21
    container_name: payara
    hostname: payara
    ports:
      - "8081:8080"
      - "4849:4848"
    environment:
      # IBM MQ Connection
      MQ_HOST: ibm-mq
      MQ_PORT: 1414
      MQ_QMGR: QM1
      MQ_CHANNEL: DEV.APP.SVRCONN
    volumes:
      - ./build/libs/test-mdb.war:/tmp/test-mdb.war:ro
      - ./docker/payara/wmq.jakarta.jmsra.rar:/tmp/wmq.jakarta.jmsra.rar:ro
      - ./docker/payara/post-boot-commands.asadmin:/opt/payara/config/post-boot-commands.asadmin:ro
    depends_on:
      ibm-mq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/opt/payara/appserver/bin/asadmin", "version"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ibm_mq_data:
